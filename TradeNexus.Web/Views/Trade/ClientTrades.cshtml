@model IEnumerable<TradeNexus.Web.Models.Trade>
@using TradeNexus.Web.Helpers

@if (Model == null || !Model.Any())
{
    <div class="alert alert-warning" style="border-radius: 15px; border: 2px solid #f5576c; background: rgba(245, 87, 108, 0.05);">
        <i class="fas fa-exclamation-triangle" style="color: #f5576c; font-size: 1.2rem;"></i>
        <strong style="color: #d63447;">No trades found</strong> for this client.
    </div>
}
else
{
    var totalTrades = Model.Count();
    var totalValue = Model.Sum(t => t.Quantity * t.Price);
    var totalBrokerage = Model.Sum(t => t.Brokerage);
    var buyTrades = Model.Count(t => t.BuySell == "BUY");
    var sellTrades = Model.Count(t => t.BuySell == "SELL");

    <!-- Summary KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 18px; text-align: center; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); transition: all 0.3s;" 
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(102, 126, 234, 0.4)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(102, 126, 234, 0.3)'">
                <h3 class="mb-0" style="font-size: 2.5rem; font-weight: 800;">@totalTrades</h3>
                <small style="opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Total Trades</small>
            </div>
        </div>
        <div class="col-md-3">
            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 18px; text-align: center; box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3); transition: all 0.3s;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(17, 153, 142, 0.4)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(17, 153, 142, 0.3)'">
                <h3 class="mb-0" style="font-size: 2.5rem; font-weight: 800;">@totalValue.ToIndianCurrency()</h3>
                <small style="opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Total Value</small>
            </div>
        </div>
        <div class="col-md-3">
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 18px; text-align: center; box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3); transition: all 0.3s;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(79, 172, 254, 0.4)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(79, 172, 254, 0.3)'">
                <h3 class="mb-0" style="font-size: 2.5rem; font-weight: 800;">@buyTrades</h3>
                <small style="opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;"><i class="fas fa-arrow-up"></i> Buy Orders</small>
            </div>
        </div>
        <div class="col-md-3">
            <div style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 25px; border-radius: 18px; text-align: center; box-shadow: 0 10px 30px rgba(235, 51, 73, 0.3); transition: all 0.3s;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(235, 51, 73, 0.4)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(235, 51, 73, 0.3)'">
                <h3 class="mb-0" style="font-size: 2.5rem; font-weight: 800;">@sellTrades</h3>
                <small style="opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;"><i class="fas fa-arrow-down"></i> Sell Orders</small>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div style="background: white; padding: 25px; border-radius: 18px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                <h6 style="font-weight: 700; margin-bottom: 20px; color: #333; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                    <i class="fas fa-pie-chart" style="color: #667eea;"></i> Buy vs Sell Distribution
                </h6>
                <canvas id="buyVsSellChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div style="background: white; padding: 25px; border-radius: 18px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);">
                <h6 style="font-weight: 700; margin-bottom: 20px; color: #333; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                    <i class="fas fa-chart-bar" style="color: #11998e;"></i> Daily Trade Volume
                </h6>
                <canvas id="dailyVolumeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Trade Details Table -->
    <div style="background: white; padding: 25px; border-radius: 18px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: auto;">
        <h6 style="font-weight: 700; margin-bottom: 20px; color: #333; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
            <i class="fas fa-list" style="color: #667eea;"></i> Trade Details
        </h6>
        <div class="table-responsive">
            <table class="table table-hover" style="margin-bottom: 0;">
                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                    <tr>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Date</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Symbol</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Segment</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Type</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Qty</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Price</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Value</th>
                        <th style="border: none; padding: 15px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;">Charges</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var trade in Model.OrderByDescending(t => t.TradeDate))
                    {
                        var tradeValue = trade.Quantity * trade.Price;
                        var totalCharges = trade.Brokerage + trade.ExchangeCharges + trade.SEBIFee + trade.StampDuty + trade.STT + trade.GST;
                        
                        <tr style="border-bottom: 1px solid #e0e0e0; transition: all 0.2s;">
                            <td style="padding: 15px; border: none;">
                                <small style="font-weight: 600; color: #333;">@trade.TradeDate.ToString("dd-MMM-yyyy")</small>
                            </td>
                            <td style="padding: 15px; border: none;">
                                <strong style="color: #667eea; font-size: 1rem;">@trade.Symbol</strong>
                                <br><small style="color: #999;">@trade.Exchange</small>
                            </td>
                            <td style="padding: 15px; border: none;">
                                <span style="background: #f0f0f0; padding: 8px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">@trade.Segment</span>
                            </td>
                            <td style="padding: 15px; border: none;">
                                @if (trade.BuySell == "BUY")
                                {
                                    <span style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; display: inline-block;">
                                        <i class="fas fa-arrow-up"></i> BUY
                                    </span>
                                }
                                else
                                {
                                    <span style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; display: inline-block;">
                                        <i class="fas fa-arrow-down"></i> SELL
                                    </span>
                                }
                            </td>
                            <td style="padding: 15px; border: none; font-weight: 600; color: #333;">@trade.Quantity</td>
                            <td style="padding: 15px; border: none; font-weight: 600; color: #333;">â‚¹@trade.Price.ToString("N2")</td>
                            <td style="padding: 15px; border: none; font-weight: 700; color: #667eea; font-size: 1.05rem;">@tradeValue.ToIndianCurrency()</td>
                            <td style="padding: 15px; border: none; color: #666;">
                                <small style="font-weight: 600;">@totalCharges.ToIndianCurrencyWithDecimals()</small>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot style="background: #f8f9ff; border-top: 3px solid #667eea;">
                    <tr>
                        <td colspan="6" style="padding: 15px; text-align: right; font-weight: 700; color: #333; border: none;">TOTAL</td>
                        <td style="padding: 15px; font-weight: 800; color: #667eea; font-size: 1.1rem; border: none;">@totalValue.ToIndianCurrency()</td>
                        <td style="padding: 15px; font-weight: 700; color: #666; border: none;">@totalBrokerage.ToIndianCurrency()</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        window._initClientCharts = function() {
            var buyCount = @buyTrades;
            var sellCount = @sellTrades;
            
            // Buy vs Sell Chart
            var ctx1 = document.getElementById('buyVsSellChart');
            if (ctx1) {
                new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Buy Orders', 'Sell Orders'],
                        datasets: [{
                            data: [buyCount, sellCount],
                            backgroundColor: [
                                'rgba(17, 153, 142, 0.8)',
                                'rgba(235, 51, 73, 0.8)'
                            ],
                            borderColor: [
                                '#11998e',
                                '#eb3349'
                            ],
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { weight: '600', size: 12 },
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            // Daily Volume Chart
            var ctx2 = document.getElementById('dailyVolumeChart');
            if (ctx2) {
                var dailyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                    Model.GroupBy(t => t.TradeDate.Date)
                    .OrderBy(g => g.Key)
                    .Select(g => new { date = g.Key.ToString("dd-MMM"), count = g.Count() })
                ));

                var labels = dailyData.map(d => d.date);
                var data = dailyData.map(d => d.count);

                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Trades',
                            data: data,
                            backgroundColor: 'rgba(17, 153, 142, 0.8)',
                            borderColor: '#11998e',
                            borderWidth: 2,
                            borderRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        };

        // Auto-call immediately since this partial is injected into an already-visible modal
        window._initClientCharts();
    </script>
}