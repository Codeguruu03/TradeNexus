@model IEnumerable<TradeNexus.Web.Models.Trade>
@using TradeNexus.Web.Helpers
@{
    ViewData["Title"] = "Trade Dashboard";
    var totalClients = Model?.Count() ?? 0;
    var totalMargin = Model?.Sum(m => m.MarginAvailable) ?? 0;
    var avgMargin = totalClients > 0 ? totalMargin / totalClients : 0;
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-tachometer-alt"></i> Trading Dashboard</h1>
            <p class="mb-0">Multi-Tenant Brokerage Management System</p>
        </div>
        <div>
            <button class="btn btn-light" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card primary position-relative">
            <i class="fas fa-users icon"></i>
            <h3>@totalClients</h3>
            <p>Total Clients</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success position-relative">
            <i class="fas fa-dollar-sign icon"></i>
            <h3>@totalMargin.ToIndianCurrency()</h3>
            <p>Total Margin</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning position-relative">
            <i class="fas fa-chart-bar icon"></i>
            <h3>@avgMargin.ToIndianCurrency()</h3>
            <p>Avg Margin/Client</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card danger position-relative">
            <i class="fas fa-building icon"></i>
            <h3>@(Model?.Select(m => m.SubBrokerId).Distinct().Count() ?? 0)</h3>
            <p>Sub-Brokers</p>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <div class="col-12">
        <div class="data-table-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0"><i class="fas fa-th-list"></i> Client Portfolio</h4>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="printTable()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>No data available.</strong> Please ensure the database is populated with trade records.
                </div>
            }
            else
            {
                <table class="table table-hover data-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Client Code</th>
                            <th><i class="fas fa-id-card"></i> Client Name</th>
                            <th><i class="fas fa-handshake"></i> Sub-Broker</th>
                            <th><i class="fas fa-map-marker-alt"></i> Location</th>
                            <th><i class="fas fa-wallet"></i> Margin Available</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><strong class="text-primary">@item.ClientCode</strong></td>
                                <td>
                                    <div>@item.ClientName</div>
                                    <small class="text-muted">PAN: @item.PAN</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">@item.SubBrokerCode</span>
                                    <br><small>@item.SubBrokerName</small>
                                </td>
                                <td>
                                    <i class="fas fa-map-pin text-danger"></i> @item.City
                                    <br><small class="text-muted">@item.State</small>
                                </td>
                                <td>
                                    <strong class="text-success">@item.MarginAvailable.ToIndianCurrency()</strong>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-info" 
                                                onclick="viewTrades(@item.ClientId, '@item.ClientName', '@item.ClientCode')">
                                            <i class="fas fa-eye"></i> View Trades
                                        </button>
                                        <button type="button" class="btn btn-sm btn-warning" 
                                                onclick="analyzeRisk(@item.ClientId, '@item.ClientName')">
                                            <i class="fas fa-chart-pie"></i> Risk Analysis
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

<!-- Trade Details Modal -->
<div class="modal fade" id="tradesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line"></i> Trade History - <span id="modalClientName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tradesContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading trade data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Risk Analysis Modal -->
<div class="modal fade" id="riskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Risk Analysis - <span id="riskClientName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="riskContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Analyzing risk metrics...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function viewTrades(clientId, clientName, clientCode) {
            $('#modalClientName').text(clientName + ' (' + clientCode + ')');
            $('#tradesModal').modal('show');
            
            $('#tradesContent').html(`
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Loading trade data...</p>
                </div>
            `);

            $.get('/Trade/ClientTrades?clientId=' + clientId, function(data) {
                $('#tradesContent').html(data);
            }).fail(function() {
                $('#tradesContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Failed to load trades.
                    </div>
                `);
            });
        }

        function analyzeRisk(clientId, clientName) {
            $('#riskClientName').text(clientName);
            $('#riskModal').modal('show');
            
            $('#riskContent').html(`
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" role="status"></div>
                    <p class="mt-3">Analyzing risk metrics...</p>
                </div>
            `);

            $.get('/Trade/CalculateRisk?clientId=' + clientId, function(data) {
                $('#riskContent').html(data);
            }).fail(function() {
                $('#riskContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Risk analysis failed.
                    </div>
                `);
            });
        }

        function exportToExcel() {
            alert('Export functionality - Coming Soon!');
        }

        function printTable() {
            window.print();
        }

        // Auto-refresh every 5 minutes
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
}

