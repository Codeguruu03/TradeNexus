@model IEnumerable<TradeNexus.Web.Models.Trade>
@using TradeNexus.Web.Helpers
@{
    ViewData["Title"] = "Trade Dashboard";
    var clients       = Model?.GroupBy(m => m.ClientId).Select(g => g.First()).ToList() ?? new List<TradeNexus.Web.Models.Trade>();
    var totalClients  = clients.Count();
    var totalMargin   = clients.Sum(c => c.MarginAvailable);
    var avgMargin     = totalClients > 0 ? totalMargin / totalClients : 0;
    var subBrokers    = clients.Select(c => c.SubBrokerId).Distinct().Count();
    var highRiskCount = clients.Count(c => c.MarginAvailable > 0 && ((decimal)(c.Quantity * c.Price) / c.MarginAvailable * 100) > 80);
    var midRiskCount  = clients.Count(c => c.MarginAvailable > 0 && ((decimal)(c.Quantity * c.Price) / c.MarginAvailable * 100) is > 50 and <= 80);
    var safeCount     = clients.Count(c => !(c.MarginAvailable > 0 && ((decimal)(c.Quantity * c.Price) / c.MarginAvailable * 100) > 50));
    var totalExposure = Model?.Sum(m => (decimal)(m.Quantity * m.Price)) ?? 0;
}

<!-- ══════════════ KPI STRIP ══════════════ -->
<div class="row g-3 mb-4">
    <!-- Total Clients -->
    <div class="col-6 col-md-3">
        <div class="kpi-card">
            <div class="kpi-card-icon" style="background:#eff6ff; color:#2563eb;"><i class="fas fa-users"></i></div>
            <div class="kpi-label">Total Clients</div>
            <div class="kpi-value" data-target="@totalClients">0</div>
            <div class="kpi-sub"><span style="color:#22c55e; font-weight:700;">●</span> @highRiskCount high risk</div>
        </div>
    </div>
    <!-- Sub-Brokers -->
    <div class="col-6 col-md-3">
        <div class="kpi-card">
            <div class="kpi-card-icon" style="background:#f0fdf4; color:#16a34a;"><i class="fas fa-building"></i></div>
            <div class="kpi-label">Sub-Brokers</div>
            <div class="kpi-value" data-target="@subBrokers">0</div>
            <div class="kpi-sub"><span style="color:#94a3b8; font-weight:600;">●</span> Active entities</div>
        </div>
    </div>
    <!-- High Risk -->
    <div class="col-6 col-md-3">
        <div class="kpi-card">
            <div class="kpi-card-icon" style="background:#fef2f2; color:#dc2626;"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="kpi-label">High Risk</div>
            <div class="kpi-value" data-target="@highRiskCount" style="color:#dc2626;">0</div>
            <div class="kpi-sub"><span style="color:#f59e0b; font-weight:700;">●</span> @midRiskCount on watchlist</div>
        </div>
    </div>
    <!-- Total Exposure -->
    <div class="col-6 col-md-3">
        <div class="kpi-card">
            <div class="kpi-card-icon" style="background:#fffbeb; color:#d97706;"><i class="fas fa-rupee-sign"></i></div>
            <div class="kpi-label">Total Exposure</div>
            <div class="kpi-value kpi-currency" data-target="@((long)totalExposure)" style="font-size:1.5rem; color:#d97706;">₹0</div>
            <div class="kpi-sub"><span style="color:#94a3b8; font-weight:600;">●</span> Avg margin ₹@avgMargin.ToString("N0")</div>
        </div>
    </div>
</div>

<!-- ══════════════ CHARTS ROW ══════════════ -->
<div class="row g-3 mb-4">
    <div class="col-md-7">
        <div class="chart-card">
            <div class="chart-card-title"><i class="fas fa-chart-bar" style="color:#2563eb;"></i> Trade Distribution</div>
            <canvas id="tradeChart" style="height:230px !important;"></canvas>
        </div>
    </div>
    <div class="col-md-5">
        <div class="chart-card">
            <div class="chart-card-title"><i class="fas fa-chart-pie" style="color:#7c3aed;"></i> Risk Breakdown</div>
            <canvas id="riskChart" style="height:230px !important;"></canvas>
        </div>
    </div>
</div>

<!-- ══════════════ CLIENTS PANEL ══════════════ -->
<div class="tn-panel">
    <!-- Panel header with search + filters -->
    <div class="tn-panel-header">
        <div class="tn-panel-title">
            <i class="fas fa-id-card" style="color:#2563eb;"></i>
            Client Portfolio
            <span style="font-size:0.65rem; font-weight:600; background:#eff6ff; color:#2563eb; padding:2px 8px; border-radius:10px; margin-left:4px;">
                @totalClients CLIENTS
            </span>
        </div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <!-- Search -->
            <div class="tn-search-wrap">
                <i class="fas fa-search tn-search-icon"></i>
                <input type="text" id="clientSearch" class="tn-search" placeholder="Search client, city, PAN…" oninput="applyFilters()">
            </div>
            <!-- Filter tabs -->
            <div class="tn-tabs">
                <button class="tn-tab tab-active-all" onclick="setFilter('all',this)">All</button>
                <button class="tn-tab" onclick="setFilter('high',this)"><i class="fas fa-circle" style="color:#ef4444;font-size:0.5rem;"></i> High Risk</button>
                <button class="tn-tab" onclick="setFilter('mid',this)"><i class="fas fa-circle" style="color:#f59e0b;font-size:0.5rem;"></i> Watchlist</button>
                <button class="tn-tab" onclick="setFilter('safe',this)"><i class="fas fa-circle" style="color:#22c55e;font-size:0.5rem;"></i> Safe</button>
            </div>
            <!-- Export -->
            <button class="cr-btn btn-trades" onclick="exportCSV()" style="padding:6px 14px;">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Table header row -->
    <div class="client-row-header">
        <div class="col-hd">Client</div>
        <div class="col-hd">Risk</div>
        <div class="col-hd">Exposure</div>
        <div class="col-hd">Margin Util.</div>
        <div class="col-hd">Sub-Broker</div>
        <div class="col-hd">Actions</div>
    </div>

    <!-- Client rows -->
    <div id="clientRows">
        @foreach (var client in clients)
        {
            var exposure  = (decimal)(client.Quantity * client.Price);
            var utilPct   = client.MarginAvailable > 0 ? Math.Min((double)(exposure / client.MarginAvailable * 100), 100) : 0;
            var riskLevel = utilPct > 80 ? "high" : (utilPct > 50 ? "mid" : "safe");
            var riskLabel = utilPct > 80 ? "High Risk" : (utilPct > 50 ? "Watchlist" : "Safe");
            var riskIcon  = utilPct > 80 ? "fa-exclamation-triangle" : (utilPct > 50 ? "fa-eye" : "fa-check-circle");
            var utilColor = utilPct > 80 ? "#ef4444" : (utilPct > 50 ? "#f59e0b" : "#22c55e");
            var pillClass = riskLevel == "high" ? "pill-high" : (riskLevel == "mid" ? "pill-mid" : "pill-safe");
            <div class="client-row"
                 data-risk="@riskLevel"
                 data-client="@(client.ClientName?.ToLower() ?? "") @(client.City?.ToLower() ?? "") @(client.State?.ToLower() ?? "") @(client.PAN?.ToLower() ?? "")">
                <!-- Name col -->
                <div>
                    <div class="cr-name">@(client.ClientName ?? "Unknown")</div>
                    <div class="cr-sub">
                        @if (!string.IsNullOrEmpty(client.City)) { <span>@client.City</span> }
                        @if (!string.IsNullOrEmpty(client.State)) { <span>&nbsp;/ @client.State</span> }
                        @if (!string.IsNullOrEmpty(client.PAN)) { <span>&nbsp;· @client.PAN</span> }
                    </div>
                </div>
                <!-- Risk pill -->
                <div>
                    <span class="risk-pill @pillClass">
                        <i class="fas @riskIcon" style="font-size:0.5rem;"></i>
                        @riskLabel
                    </span>
                </div>
                <!-- Exposure -->
                <div>
                    <div class="cr-val">₹@exposure.ToString("N0")</div>
                    <div class="cr-meta">Qty @client.Quantity</div>
                </div>
                <!-- Utilization bar -->
                <div>
                    <div class="util-inline">
                        <div class="util-track">
                            <div class="util-fill" style="width:0%; background:@utilColor;" data-pct="@utilPct.ToString("0")"></div>
                        </div>
                        <div class="util-pct" style="color:@utilColor;">@utilPct.ToString("0")%</div>
                    </div>
                    <div class="cr-meta" style="margin-top:3px;">₹@client.MarginAvailable.ToString("N0") margin</div>
                </div>
                <!-- Sub-broker -->
                <div>
                    <div class="cr-val" style="font-size:0.78rem; color:#374151;">@(client.SubBrokerId > 0 ? client.SubBrokerId.ToString() : "—")</div>
                    @if (!string.IsNullOrEmpty(client.SubBrokerCode)) {
                        <div class="cr-meta">@client.SubBrokerCode</div>
                    }
                </div>
                <!-- Actions -->
                <div style="display:flex; gap:6px;">
                    <button class="cr-btn btn-trades"
                            onclick="loadClientTrades('@client.ClientId', '@Html.Raw(client.ClientName?.Replace("'","\'"))')"
                            title="View Trades">
                        <i class="fas fa-list-alt"></i> Trades
                    </button>
                    <button class="cr-btn btn-riskx"
                            onclick="loadRiskData('@client.ClientId', '@Html.Raw(client.ClientName?.Replace("'","\'"))')"
                            title="Risk Analysis">
                        <i class="fas fa-robot"></i>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- No results -->
    <div id="noResults" style="display:none; text-align:center; padding:40px; color:#94a3b8;">
        <i class="fas fa-search" style="font-size:1.5rem; margin-bottom:10px; display:block;"></i>
        No clients match your filters
    </div>
</div>

<!-- ══════════════ MODALS ══════════════ -->
<!-- Trades Modal -->
<div class="modal fade" id="tradesModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header trade-mh">
                <h5 class="modal-title"><i class="fas fa-list-alt" style="color:#2563eb; margin-right:8px;"></i><span id="tradesModalTitle">Client Trades</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tradesModalContent" style="padding:20px; min-height:200px; background:white;">
                <div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>
            </div>
        </div>
    </div>
</div>
<!-- Risk Modal -->
<div class="modal fade" id="riskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header risk-mh">
                <h5 class="modal-title"><i class="fas fa-robot" style="color:#dc2626; margin-right:8px;"></i><span id="riskModalTitle">Risk Analysis</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="riskModalContent" style="padding:20px; min-height:200px; background:white;">
                <div class="text-center p-4"><div class="spinner-border text-danger" role="status"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- ══════════════ SCRIPTS ══════════════ -->
@section Scripts {
<script>
// ── Data from server ──
var chartData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
    clients.Select(c => new {
        name    = c.ClientName ?? "Unknown",
        exposure= (double)(c.Quantity * c.Price),
        margin  = (double)c.MarginAvailable,
        risk    = c.MarginAvailable > 0 && (decimal)(c.Quantity * c.Price) / c.MarginAvailable * 100 > 80 ? "high"
                : c.MarginAvailable > 0 && (decimal)(c.Quantity * c.Price) / c.MarginAvailable * 100 > 50 ? "mid" : "safe"
    })
));

var highCount  = @highRiskCount;
var midCount   = @midRiskCount;
var safeCount  = @safeCount;

// ── Count-up animation ──
document.querySelectorAll('.kpi-value[data-target]').forEach(function(el) {
    var target = parseInt(el.getAttribute('data-target')) || 0;
    var isCurr = el.classList.contains('kpi-currency');
    var start  = 0, steps = 60, cur = 0;
    var step   = target / steps;
    var timer  = setInterval(function() {
        cur = Math.min(cur + step, target);
        el.textContent = isCurr ? '₹' + Math.floor(cur).toLocaleString('en-IN') : Math.floor(cur);
        if (cur >= target) clearInterval(timer);
    }, 16);
});

// ── Animate utilization bars ──
setTimeout(function() {
    document.querySelectorAll('.util-fill').forEach(function(bar) {
        var pct = bar.getAttribute('data-pct') || '0';
        bar.style.width = pct + '%';
    });
}, 200);

// ── Charts ──
(function() {
    var topClients = chartData.slice(0,8);
    var labels = topClients.map(function(c){ return c.name.split(' ')[0]; });
    var exposures = topClients.map(function(c){ return Math.round(c.exposure); });
    var barColors = topClients.map(function(c){
        return c.risk === 'high' ? 'rgba(239,68,68,0.75)' : c.risk === 'mid' ? 'rgba(245,158,11,0.75)' : 'rgba(37,99,235,0.75)';
    });

    // Trade / exposure bar chart
    var ctx1 = document.getElementById('tradeChart');
    if (ctx1) {
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Exposure (₹)',
                    data: exposures,
                    backgroundColor: barColors,
                    borderRadius: 6, borderSkipped: false
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: { duration: 1000, easing: 'easeInOutQuart' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(c) { return '₹' + c.raw.toLocaleString('en-IN'); }
                        }
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#f1f5f9' },
                        ticks: {
                            color: '#94a3b8', font: { size: 10 },
                            callback: function(v) { return '₹' + (v/1000 > 0 ? v/1000 + 'K' : v); }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#374151', font: { size: 10 } }
                    }
                }
            }
        });
    }

    // Risk donut
    var ctx2 = document.getElementById('riskChart');
    if (ctx2) {
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['High Risk', 'Watchlist', 'Safe'],
                datasets: [{
                    data: [highCount, midCount, safeCount],
                    backgroundColor: ['#ef4444','#f59e0b','#22c55e'],
                    borderWidth: 3, borderColor: '#fff',
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: { animateRotate: true, duration: 1000 },
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#374151', font: { size: 11 }, padding: 16 }
                    }
                }
            }
        });
    }
})();

// ── Filter logic ──
var activeFilter = 'all';
function setFilter(f, btn) {
    activeFilter = f;
    document.querySelectorAll('.tn-tab').forEach(function(b) {
        b.className = 'tn-tab';
    });
    if (f === 'all')  btn.classList.add('tab-active-all');
    if (f === 'high') btn.classList.add('tab-active-high');
    if (f === 'mid')  btn.classList.add('tab-active-mid');
    if (f === 'safe') btn.classList.add('tab-active-safe');
    applyFilters();
}
function applyFilters() {
    var term = document.getElementById('clientSearch').value.toLowerCase();
    var rows = document.querySelectorAll('#clientRows .client-row');
    var visible = 0;
    rows.forEach(function(row) {
        var matchR = (activeFilter === 'all') || (row.dataset.risk === activeFilter);
        var matchS = !term || row.dataset.client.includes(term);
        var show   = matchR && matchS;
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    document.getElementById('noResults').style.display = (visible === 0) ? '' : 'none';
}

// ── Trades modal ──
function loadClientTrades(clientId, clientName) {
    document.getElementById('tradesModalTitle').textContent = clientName + ' – Trades';
    document.getElementById('tradesModalContent').innerHTML =
        '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>';
    new bootstrap.Modal(document.getElementById('tradesModal')).show();
    fetch('/Trade/GetClientTrades?clientId=' + encodeURIComponent(clientId))
        .then(function(r){ return r.text(); })
        .then(function(html) {
            document.getElementById('tradesModalContent').innerHTML = html;
            showToast('Trade data loaded', '#2563eb');
        })
        .catch(function() {
            document.getElementById('tradesModalContent').innerHTML =
                '<div class="text-center p-4" style="color:#dc2626;"><i class="fas fa-times-circle fa-2x"></i><p class="mt-2">Failed to load trades</p></div>';
            showToast('Failed to load trades', '#ef4444');
        });
}

// ── Risk modal ──
function loadRiskData(clientId, clientName) {
    document.getElementById('riskModalTitle').textContent = clientName + ' – Risk Analysis';
    document.getElementById('riskModalContent').innerHTML =
        '<div class="text-center p-4"><div class="spinner-border text-danger" role="status"></div></div>';
    new bootstrap.Modal(document.getElementById('riskModal')).show();
    fetch('/Trade/GetRiskAnalysis?clientId=' + encodeURIComponent(clientId))
        .then(function(r){ return r.text(); })
        .then(function(html) {
            document.getElementById('riskModalContent').innerHTML = html;
            showToast('Risk analysis loaded', '#22c55e');
        })
        .catch(function() {
            document.getElementById('riskModalContent').innerHTML =
                '<div class="text-center p-4" style="color:#dc2626;"><i class="fas fa-times-circle fa-2x"></i><p class="mt-2">Risk data unavailable</p></div>';
            showToast('Risk data unavailable', '#ef4444');
        });
}

// ── Export CSV ──
function exportCSV() {
    var rows = document.querySelectorAll('#clientRows .client-row:not([style*="display: none"])');
    var csv  = 'Client,Risk,Sub-Broker\n';
    rows.forEach(function(r) {
        var name = r.querySelector('.cr-name')?.textContent?.trim() || '';
        var risk = r.dataset.risk || '';
        var sub  = r.querySelectorAll('.cr-val')[1]?.textContent?.trim() || '';
        csv += [name, risk, sub].join(',') + '\n';
    });
    var a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'tradenexus_clients.csv';
    a.click();
    showToast('Export complete ✓', '#22c55e');
}
</script>
}
